<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>後台管理系統</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .admin-container {
            padding: 100px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .message-full {
            max-width: 300px;
            white-space: pre-wrap;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            background: #e3f2fd;
            color: #1976d2;
        }

        /* 分頁樣式 */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .has-pagination {
            position: relative;
            padding-bottom: 60px;
            /* 預留分頁空間 */
        }

        .page-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-btn:hover:not(.active) {
            background: #f0f0f0;
        }
    </style>
</head>

<body>
    <header class="navbar">
        <div class="container">
            <a href="index.html" class="logo">
                <img src="imgs/logo.svg" alt="網站 Logo">
            </a>
            <nav class="nav-links">
                <a href="index.html" class="nav-link">返回首頁</a>
                <a href="#" class="nav-link" id="logoutBtn">登出</a>
            </nav>
        </div>
    </header>

    <div class="admin-container">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="admin-header">
                        <h1>後台管理中心</h1>
                        <p>歡迎回來，管理員</p>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="admin-section has-pagination">
                        <h2>最新留言</h2>
                        <div class="table-responsive">
                            <table id="messagesTable" class="table">
                                <thead>
                                    <tr>
                                        <th>時間</th>
                                        <th>姓名</th>
                                        <th>Email</th>
                                        <th>主題</th>
                                        <th>內容</th>
                                        <th>帳號</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" style="text-align:center;">載入中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="messagesPagination"></div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="admin-section has-pagination">
                        <h2>註冊用戶列表</h2>
                        <div class="table-responsive">
                            <table id="usersTable" class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>用戶名</th>
                                        <th>Email</th>
                                        <th>註冊時間</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="4" style="text-align:center;">載入中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="usersPagination"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="footer-copyright">
                        <p>版權所有 © 2025 作品集作者</p>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 狀態管理
        let currentUsersPage = 1;
        let currentMsgsPage = 1;

        document.addEventListener('DOMContentLoaded', function () {
            loadData();

            // 登出功能
            document.getElementById('logoutBtn').addEventListener('click', function (e) {
                e.preventDefault();
                fetch('/api/logout').then(() => {
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('username');
                    window.location.href = 'index.html';
                });
            });
        });

        function loadData(usersPage = currentUsersPage, msgsPage = currentMsgsPage) {
            fetch(`/api/admin/data?page_users=${usersPage}&page_msgs=${msgsPage}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert(data.message || '無法存取後台資料');
                        window.location.href = 'index.html';
                        return;
                    }

                    // 更新全域頁數狀態
                    currentUsersPage = data.users.current_page;
                    currentMsgsPage = data.messages.current_page;

                    renderUsers(data.users.data);
                    renderPagination('usersPagination', data.users, (page) => loadData(page, currentMsgsPage));

                    renderMessages(data.messages.data);
                    renderPagination('messagesPagination', data.messages, (page) => loadData(currentUsersPage, page));
                })
                .catch(err => {
                    console.error(err);
                    alert('發生錯誤');
                });
        }

        function renderUsers(users) {
            const tbody = document.querySelector('#usersTable tbody');
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">暫無用戶</td></tr>';
                return;
            }
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${escapeHtml(user.username)}</td>
                    <td>${escapeHtml(user.email)}</td>
                    <td>${user.created_at}</td>
                </tr>
            `).join('');
        }

        function renderMessages(messages) {
            const tbody = document.querySelector('#messagesTable tbody');
            if (!messages || messages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">暫無留言</td></tr>';
                return;
            }
            tbody.innerHTML = messages.map(msg => `
                <tr>
                    <td>${msg.created_at}</td>
                    <td>${escapeHtml(msg.name)}</td>
                    <td>${escapeHtml(msg.email)}</td>
                    <td>${escapeHtml(msg.subject)}</td>
                    <td class="message-full">${escapeHtml(msg.message)}</td>
                    <td>${msg.user_name ? `<span class="status-badge">${escapeHtml(msg.user_name)}</span>` : '<span style="color:#999">訪客</span>'}</td>
                </tr>
            `).join('');
        }

        function renderPagination(containerId, meta, onPageClick) {
            const container = document.getElementById(containerId);
            const { current_page, total_pages } = meta;

            if (total_pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            // 上一頁
            if (current_page > 1) {
                html += `<button class="page-btn" onclick="handlePageClick('${containerId}', ${current_page - 1})">上一頁</button>`;
            }

            // 頁碼 (簡單顯示前後幾頁，太長可優化但範例先固定顯示全部或部分)
            for (let i = 1; i <= total_pages; i++) {
                // 簡單邏輯：顯示所有頁碼，若頁數極多可加入省略號邏輯
                html += `<button class="page-btn ${i === current_page ? 'active' : ''}" onclick="handlePageClick('${containerId}', ${i})">${i}</button>`;
            }

            // 下一頁
            if (current_page < total_pages) {
                html += `<button class="page-btn" onclick="handlePageClick('${containerId}', ${current_page + 1})">下一頁</button>`;
            }

            container.innerHTML = html;

            // 暫存 callback 到 window 方便 onclick 調用
            if (!window.pageCallbacks) window.pageCallbacks = {};
            window.pageCallbacks[containerId] = onPageClick;
        }

        // 全域處理函數
        window.handlePageClick = function (containerId, page) {
            if (window.pageCallbacks && window.pageCallbacks[containerId]) {
                window.pageCallbacks[containerId](page);
            }
        };

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>

</html>